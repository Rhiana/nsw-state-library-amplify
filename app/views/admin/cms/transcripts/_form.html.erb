<style>
.ui-autocomplete-loading {
  background: white url("/img/ui-anim_basic_16x16.gif") right center no-repeat;
}
</style>
<div class="row">
  <div class="col-12">
    <%= form_for [:admin, :cms, @transcript], html: { multipart: true } do |f| %>
      <%= render partial: "admin/cms/shared/errors",
                 locals: { resource: @transcript }
       %>

      <div class="form-group">
        <%= f.label :uid %>
        <%= f.text_field :uid, class: "form-control" %>
      </div>

      <div class="form-group">
        <%= f.label :title %>
        <%= f.text_field :title, class: "form-control" %>
      </div>

      <div class="form-group">
        <%= f.label :url, "Audio collection catalogue url" %>
        <%= f.text_field :url, class: "form-control" %>
      </div>

      <div class="form-group">
        <%= f.label :audio %>
        <%= f.file_field :audio, class: "form-control" %>
      </div>

      <div class="form-group">
        <%= f.label :script, "Transcript" %>
        <%= f.file_field :script, class: "form-control" %>
      </div>

      <div class="form-group">
        <%= f.label :description %>
        <%= f.text_area :description, class: "form-control", rows: "6" %>
      </div>

      <div class="form-group">
        <%= f.label :speakers %>
        <%= f.text_field :speakers, class: "form-control" %>
      </div>

      <div class="form-group">
        <%= image_tag(@transcript.image.thumb) if @transcript.image.present? %>
        <%= f.label :image %>
        <%= f.file_field :image, class: "form-control" %>
      </div>

      <div class="form-group">
        <%= f.label :image_caption %>
        <%= f.text_field :image_caption, class: "form-control" %>
      </div>

      <div class="form-group">
        <%= f.label :image_catalogue_url %>
        <%= f.text_field :image_catalogue_url, class: "form-control" %>
      </div>

      <div class="form-group">
        <%= f.label :vendor_id %>
        <%= f.select :vendor_id, Vendor.pluck(:name, :id), class: "form-control" %>
      </div>

      <div class="hidden-form-fields">
        <%= f.hidden_field(:collection_id, value: @transcript.collection_id) %>
      </div>

      <div class="form-group text-center">
        <%= f.submit %>
        <%= link_to "Cancel", :back, class: "button" %>
      </div>
    <% end %>
  </div>
</div>

<script>
$( function() {
function split( val ) {
  return val.split( /;\s*/ );
}
function extractLast( term ) {
  return split( term ).pop();
}

$( "#transcript_speakers" )
  // don't navigate away from the field on tab when selecting an item
  .on( "keydown", function( event ) {
    if ( event.keyCode === $.ui.keyCode.TAB &&
        $( this ).autocomplete( "instance" ).menu.active ) {
      event.preventDefault();
    }
  })
  .autocomplete({
    source: function( request, response ) {
      $.getJSON( "/admin/cms/transcript/speaker_search", {
        q: extractLast( request.term )
      }, response );
    },
    search: function() {
      // custom minLength
      var term = extractLast( this.value );
      if ( term.length < 2 ) {
        return false;
      }
    },
    focus: function() {
      // prevent value inserted on focus
      return false;
    },
    select: function( event, ui ) {
      var terms = split( this.value );
      // remove the current input
      terms.pop();
      // add the selected item
      terms.push( ui.item.value );
      // add placeholder to get the comma-and-space at the end
      terms.push( "" );
      this.value = terms.join( "; " );
      return false;
    }
  });
} );
</script>
